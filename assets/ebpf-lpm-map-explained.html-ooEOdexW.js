import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{a as k,h as p,e as r,f as a,b as i,r as d,o as c,g as s}from"./app-dowPD55j.js";const o={};function g(A,e){const n=d("CodeTabs");return c(),k("div",null,[e[4]||(e[4]=p(`<div class="hint-container warning"><p class="hint-container-title">This article assumes that the reader is already aware of ebpf.</p></div><p>Since its inception, eBPF has enabled a variety of use cases. Initially, eBPF was primarily focused on the network stack, which led to the development of the Express Data Path (XDP). One example is a packet filter that uses eBPF-XDP to deliver enhanced security, greater customization, and lower performance overhead.</p><p>Few use-cases of XDP include,</p><ul><li>Pre-stack processing like filtering to support DDoS mitigation</li><li>Forwarding, load balancing and etc.,</li></ul><p>We will mainly focus on <strong>packet filter</strong> for this article. The <a href="https://github.com/xdp-project/xdp-tools/tree/main/xdp-filter" target="_blank" rel="noopener noreferrer">xdp-filter</a> from the <code>xdp-project</code> provides an example of implementing a packet filter using the xdp technology.</p><h2 id="lpm-trie" tabindex="-1"><a class="header-anchor" href="#lpm-trie"><span>LPM Trie</span></a></h2><p><code>LPM</code> - Longest Prefix Match. As the name suggests, a key will be matched based on the maximum prefix length match. In other words, the key is compared to various prefixes, and the prefix that best (i.e., most specifically) matches the key is chosen.</p><h3 id="why-lpm-trie-map" tabindex="-1"><a class="header-anchor" href="#why-lpm-trie-map"><span>Why LPM Trie map?</span></a></h3><p>The <code>xdp-filter</code> example uses a <code>PerCPU-Hash</code> map to look up IP entries for filtering. In a production environment with multiple VLAN segments, filtering communication between VLANs by explicitly listing all IPs is impractical. Adding a large number of IPs would consume excessive memory for the map itself.</p><p>This is where <code>LPM-Trie</code> map shines. Instead of listing down all IPs, we can just mention the VLAN cidr bit as the prefix length for matching. Consider a VLAN segment <code>192.168.10.0/24</code>, this can be expressed as,</p><ul><li>Prefix length : 24</li><li>Address/Data : 192.168.10.0</li></ul><p>When a lookup for <code>192.168.10.10</code> is done, the key <code>192.168.10.0/24</code> will match and we can proceed filtering the traffic. Unlike, percpu-hash which uses a full IPv4 length, using LPM-Trie we can hold huge IP addresses in a single key.</p><h3 id="defining-the-lpm-map" tabindex="-1"><a class="header-anchor" href="#defining-the-lpm-map"><span>Defining the LPM Map</span></a></h3><p>We will use the <a href="https://docs.kernel.org/bpf/map_lpm_trie.html" target="_blank" rel="noopener noreferrer"><code>BPF_MAP_TYPE_LPM_TRIE</code></a> type when declaring the map type.</p><div class="hint-container caution"><p class="hint-container-title"><code>BPF_F_NO_PREALLOC</code> flag</p><p>When creating a map of type <code>BPF_MAP_TYPE_LPM_TRIE</code>, you <strong>must</strong> set the <code>BPF_F_NO_PREALLOC</code> flag.</p></div><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="LPM Map definition" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lpm_key{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __u32 prefixlen;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __u32 data;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __uint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(type, BPF_MAP_TYPE_LPM_TRIE);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lpm_key);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(value, __u32);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __uint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(map_flags, BPF_F_NO_PREALLOC);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __uint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(max_entries, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">255</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} lpm_map </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SEC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;.maps&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The above is as defined in the kernel docs of BPF LPM Trie map. But, what if we want to filter both IPv4 and IPv6 IPs? We can have two separate keys and maps to filter them when parsing the packet using xdp. That&#39;s kind of ugly. Let&#39;s redefine the <code>lpm_key</code> to accomodate both IPv4 and IPv6 addresses. An IPv6 address is 128-bits. Hence, we define a <code>struct ip</code> to be of 128 bits (4 x 32).</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ip {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __u32 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //IPv6 is 128 bits.</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lpm_key {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __u32 prefixlen;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ip addr;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="but-how-to-define-ipv4-addresses" tabindex="-1"><a class="header-anchor" href="#but-how-to-define-ipv4-addresses"><span>But, how to define IPv4 addresses?</span></a></h4><p>In case of IPv4 addresses, we can represent an IPv4 address as IPv6 mapped address.</p><table><thead><tr><th>IPv4</th><th>IPv6-mapped</th></tr></thead><tbody><tr><td>192.168.10.10</td><td>0000:0000:0000:0000:0000:ffff:c0a8:0a0a</td></tr></tbody></table><p>Notice, that the IPv4 address sits at the last in hex-notation and the before places are filled with <code>00</code> and <code>ff</code>&#39;s? We will do the same when defining our struct for IPv4 addresses. i.e.,</p><div class="language-c" data-highlighter="shiki" data-ext="c" data-title="v4 to v6-mapped" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 0000:0000</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 0000:0000</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;"> 0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0000ffff</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 0000:ffff</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3232238090</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // c0a8:0a0a</span></span></code></pre></div><h3 id="populating-the-lpm-map" tabindex="-1"><a class="header-anchor" href="#populating-the-lpm-map"><span>Populating the LPM Map</span></a></h3><p>When populating our LPM map, be aware that our LPM key now supports both IPv4 and IPv6 address. Our <code>prefixlen</code> should reflect the same. For IPv4 addresses, the first 3 indicies of our ip array is constant. Our prefix len for IPv4 addresses can be calculated as <code>constant</code> + <code>CIDR bit</code>. Ex: The prefixlen for <code>192.168.10.0/24</code> is <strong>120</strong>.</p><ul><li>Constant (3-places): 3 * 32 = 96</li><li>CIDR bit : 24</li></ul><h3 id="querying-the-lpm-map" tabindex="-1"><a class="header-anchor" href="#querying-the-lpm-map"><span>Querying the LPM Map</span></a></h3><p>When querying the <code>lpm_map</code>, the prefixlen should be calculated as highlighted below. Handling of IPv4 address is highlighted in the below code.</p>`,28)),r(n,{id:"125",data:[{id:"lpm_packet_filer.bpf.c"},{id:"map_defs.h"}]},{title0:a(({value:t,isActive:l})=>e[0]||(e[0]=[s("lpm_packet_filer.bpf.c")])),title1:a(({value:t,isActive:l})=>e[1]||(e[1]=[s("map_defs.h")])),tab0:a(({value:t,isActive:l})=>e[2]||(e[2]=[i("div",{class:"language-c line-numbers-mode has-collapsed-lines collapsed","data-highlighter":"shiki","data-ext":"c","data-title":"filter.bpf.c",style:{"--vp-collapsed-lines":"15","--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[i("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"SEC"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#50A14F","--shiki-dark":"#98C379"}},'"xdp"'),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"int"),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," packet_filter"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," xdp_md "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"*"),i("span",{style:{"--shiki-light":"#383A42","--shiki-light-font-style":"inherit","--shiki-dark":"#E06C75","--shiki-dark-font-style":"italic"}},"ctx"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},") {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"    __u32 action "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," XDP_DROP;"),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}}," // default action")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"    // Ethernet, IP, Protocol header parsing...")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," ip addr "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," {};")]),s(`
`),i("span",{class:"line highlighted"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    if"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," (eth_type "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"=="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," ETH_P_IP) {"),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"    // IPv4 address")]),s(`
`),i("span",{class:"line highlighted"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"        addr"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}},"ip"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"["),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"2"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"] "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," bpf_htonl"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#E06C75"}},"0x"),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"0000ffff"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},");")]),s(`
`),i("span",{class:"line highlighted"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"        addr"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}},"ip"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"["),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"3"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"] "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}}," iphdr"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"->"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}},"saddr"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";"),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"   // iphdr --> struct iphdr")]),s(`
`),i("span",{class:"line highlighted"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"    }")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," lpm_key key "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," {};")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"    memset"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"&"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"key, "),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"0"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},", "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"sizeof"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," lpm_key));")]),s(`
`),i("span",{class:"line highlighted"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"    key"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}},"prefixlen"),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," ="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," ("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"sizeof"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," lpm_key) "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"-"),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}}," 4"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},") "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"*"),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}}," 8"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";"),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}}," // remove 4 bytes used for prefixlen")]),s(`
`),i("span",{class:"line highlighted"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"    key"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}},"addr"),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," ="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," addr;")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"    __u32 is_allowed "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," bpf_map_lookup_elem"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"&"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"lpm_map, "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"&"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"key);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    if"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," (is_allowed) {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"        action "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"="),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," XDP_PASS;")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"    }")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    return"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," action;")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"}")])])]),i("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"})]),i("div",{class:"collapsed-lines"})],-1)])),tab1:a(({value:t,isActive:l})=>e[3]||(e[3]=[i("div",{class:"language-c line-numbers-mode has-collapsed-lines collapsed","data-highlighter":"shiki","data-ext":"c","data-title":"map_defs.h",style:{"--vp-collapsed-lines":"15","--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[i("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," ip {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"    __u32 "),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}},"ip"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"["),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"4"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"];"),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"  //IPv6 is 128 bits.")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"}")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," lpm_key {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"    __u32 prefixlen;")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," ip addr;")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"}")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"        __uint"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"(type, BPF_MAP_TYPE_LPM_TRIE);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"        __type"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"(key, "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"struct"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," lpm_key);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"        __type"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"(value, __u32);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"        __uint"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"(map_flags, BPF_F_NO_PREALLOC);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"        __uint"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"(max_entries, "),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"255"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"} lpm_map "),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"SEC"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#50A14F","--shiki-dark":"#98C379"}},'".maps"'),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},");")])])]),i("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"})]),i("div",{class:"collapsed-lines"})],-1)])),_:1}),e[5]||(e[5]=i("p",null,"Thank you for reading! See you in the next post.",-1))])}const m=h(o,[["render",g],["__file","ebpf-lpm-map-explained.html.vue"]]),u=JSON.parse('{"path":"/blog/ebpf-lpm-map-explained.html","title":"eBPF: Using LPM Trie map to filter packets","lang":"en-US","frontmatter":{"title":"eBPF: Using LPM Trie map to filter packets","date":"2025-03-01T00:00:00.000Z","category":["linux","ebpf","network"],"tags":["LPM Trie","Trie","maps","filter","packets","firewall","ebpf"],"excerpt":"<p>Ever since the advent of ebpf, various use-cases have sprung up where ebpf can be used. One such example is a packet-filter that leverages ebpf to provide more security, customisable and with less performance overhead. Lets understand how to build our own packet filter using LPM map.</p>","description":"This article assumes that the reader is already aware of ebpf. Since its inception, eBPF has enabled a variety of use cases. Initially, eBPF was primarily focused on the network...","head":[["meta",{"property":"og:url","content":"https://syogaraj.github.io/blog/ebpf-lpm-map-explained.html"}],["meta",{"property":"og:site_name","content":"Yogaraj.S"}],["meta",{"property":"og:title","content":"eBPF: Using LPM Trie map to filter packets"}],["meta",{"property":"og:description","content":"This article assumes that the reader is already aware of ebpf. Since its inception, eBPF has enabled a variety of use cases. Initially, eBPF was primarily focused on the network..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-03-01T02:19:05.000Z"}],["meta",{"property":"article:tag","content":"LPM Trie"}],["meta",{"property":"article:tag","content":"Trie"}],["meta",{"property":"article:tag","content":"maps"}],["meta",{"property":"article:tag","content":"filter"}],["meta",{"property":"article:tag","content":"packets"}],["meta",{"property":"article:tag","content":"firewall"}],["meta",{"property":"article:tag","content":"ebpf"}],["meta",{"property":"article:published_time","content":"2025-03-01T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-03-01T02:19:05.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"eBPF: Using LPM Trie map to filter packets\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-01T00:00:00.000Z\\",\\"dateModified\\":\\"2025-03-01T02:19:05.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Yogaraj. S\\",\\"email\\":\\"yogarajsivaprakasam@gmail.com\\"}]}"]]},"headers":[{"level":2,"title":"LPM Trie","slug":"lpm-trie","link":"#lpm-trie","children":[{"level":3,"title":"Why LPM Trie map?","slug":"why-lpm-trie-map","link":"#why-lpm-trie-map","children":[]},{"level":3,"title":"Defining the LPM Map","slug":"defining-the-lpm-map","link":"#defining-the-lpm-map","children":[]},{"level":3,"title":"Populating the LPM Map","slug":"populating-the-lpm-map","link":"#populating-the-lpm-map","children":[]},{"level":3,"title":"Querying the LPM Map","slug":"querying-the-lpm-map","link":"#querying-the-lpm-map","children":[]}]}],"git":{"createdTime":1740795545000,"updatedTime":1740795545000,"contributors":[{"name":"yogaraj.s","username":"yogaraj.s","email":"yogarajsivaprakasam@gmail.com","commits":1,"url":"https://github.com/yogaraj.s"}]},"readingTime":{"minutes":2.93,"words":879},"filePathRelative":"blog/ebpf-lpm-map-explained.md","localizedDate":"March 1, 2025","autoDesc":true}');export{m as comp,u as data};
